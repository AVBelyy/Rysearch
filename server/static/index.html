<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links {
		  stroke: #000;
		  stroke-opacity: 0.2;
}

.polygons {
		  fill: green;
		  stroke: #000;
}

.polygons #selected-polygon {
		  fill: #f00;
}

.sites {
		  fill: #000;
		  stroke: #fff;
}

.sites :first-child {
		  fill: green;
}

.titles {
	fill: #000;
	stroke: #000;
	background: #00F;
}

</style>
<svg width="1150" height="700"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript">

var svg = d3.select("svg").on("touchmove mousemove", moved),
	    width = +svg.attr("width"),
		  height = +svg.attr("height");

N_sites = 22
random_factor = 0.3

function calculateColsRowsNum(width, height, N_points) {
	var alpha = width/height;
	var num_points_h = Math.ceil(Math.sqrt(N_points/alpha)),
	num_points_w = Math.ceil(N_points/num_points_h);
	return [num_points_w, num_points_h]
}

function getCellSize(width, height, N_points) {
	var num_points = calculateColsRowsNum(width, height, N_points),
	 	num_points_w = num_points[0], num_points_h = num_points[1];
	var cell_width = Math.floor(width/num_points_w), cell_height = Math.floor(height/num_points_h);
	return [cell_width, cell_height]
}

function getPoints(width, height, N_points, random_factor) {
	var num_points = calculateColsRowsNum(width, height, N_points),
	 	num_points_w = num_points[0], num_points_h = num_points[1];
	var cell_size = getCellSize(width, height, N_points),
	 	cell_width = cell_size[0], cell_height = cell_size[1];
	var coordinates_of_points = [];
	for (var i = 0, points_counter = 0, w = Math.floor(cell_width/2);
	 (i < num_points_w) & (points_counter < N_points); i++, w += cell_width) {
		for (var j = 0, h = Math.floor(cell_height/2); (j < num_points_h) & (points_counter < N_points); j++, h += cell_height) {
			coordinates_of_points.push([w + Math.random()*random_factor*cell_width,
				 													h + Math.random()*random_factor*cell_width]);
			points_counter++;
		}
	}

	return coordinates_of_points;
}


var sites = getPoints(width, height, N_sites, random_factor)

var voronoi = d3.voronoi()
  	.extent([[-1, -1], [width + 1, height + 1]]);

var polygon = svg.append("g")
	.attr("class", "polygons")
	.selectAll("path")
	.data(voronoi.polygons(sites))
	.enter().append("path")
	.call(redrawPolygon)
	;

/*
	var link = svg.append("g")
		.attr("class", "links")
		.selectAll("line")
		.data(voronoi.links(sites))
		.enter().append("line")
		.call(redrawLink);

var site = svg.append("g")
	.attr("class", "sites")
	.selectAll("circle")
	.data(sites)
	.enter().append("circle")
	.attr("r", 2.5)
	.call(redrawSite);
*/
var titles = svg.append("g")
	.attr("class", "titles")
	.selectAll("text")
	.data(d3.zip(d3.range(N_sites), sites))
	.enter().append("text")
	.call(redrawTitle);

function moved() {
	highlight_cell(d3.mouse(this));
}

function highlight_cell() {

}

function redraw() {
	var diagram = voronoi(sites);
	polygon = polygon.data(diagram.polygons()).call(redrawPolygon);
	//link = link.data(diagram.links()), link.exit().remove();
	//link = link.enter().append("line").merge(link).call(redrawLink);
	site = site.data(sites).call(redrawSite);
}

function redrawPolygon(polygon) {
	polygon.attr("d", function(d) {
		return d ? "M" + d.join("L") + "Z" : null;
	});
}

function redrawTitle(title) {
	var cell_size = getCellSize(width, height, N_sites),
		cell_width = cell_size[0], cell_height = cell_size[1];

	title
		.text(function(d) {return "Topic " + d[0];})
		.attr("x", function(d) {
			var x = Math.floor(d[1][0]) - Math.floor((1-2*random_factor)*cell_width*0.5);
				return x;})
		.attr("y", function(d) {
			var y = Math.floor(d[1][1]) - Math.floor((1-2*random_factor)*cell_height*0.5);
			return y;})
}

function redrawLink(link) {
  link
		.attr("x1", function(d) { return d.source[0]; })
		.attr("y1", function(d) { return d.source[1]; })
		.attr("x2", function(d) { return d.target[0]; })
		.attr("y2", function(d) { return d.target[1]; });
}

function redrawSite(site) {
	site
		.attr("cx", function(d) { return d[0]; })
		.attr("cy", function(d) { return d[1]; });
}

</script>
